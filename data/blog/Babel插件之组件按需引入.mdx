---
title: 'ğŸ›¸ Babelæ’ä»¶ä¹‹ç»„ä»¶æŒ‰éœ€å¼•å…¥'
date: '2022-03-01'
tags: ['Babel']
draft: false
summary: 'å®ç°ç»„ä»¶æŒ‰éœ€å¼•å…¥é™ä½é¡¹ç›®è´Ÿè½½'
---
### ç»„ä»¶æŒ‰éœ€å¼•å…¥

**å®‰è£…æ’ä»¶babel-plugin-component**ï¼Œå¼•å…¥éœ€è¦çš„ç»„ä»¶ï¼Œä»¥è¾¾åˆ°é™ä½é¡¹ç›®ä½“ç§¯ã€‚

#### **ç›®çš„**

ä¸€èˆ¬çš„ç»„ä»¶å¼•å…¥çš„æ–¹å¼ï¼š`import Button from "../UI/packages/button"`

æƒ³è¦è¾¾æˆçš„å¼•å…¥æ–¹å¼ï¼š`import {Button} from "../UI''`

#### **æªæ–½**

> å‰ç½®çŸ¥è¯†babel-plugin-componentæ’ä»¶
>
> babel-plugin-componenté€šè¿‡ä¿®æ”¹å¼•å…¥ä»£ç å¯¹åº”çš„ASTæ ‘æ¥è¾¾åˆ°æç®€çš„å¼•å…¥ç»„ä»¶çš„ç›®çš„
>
> `import { Alert } from 'xui'`å¯¹åº”çš„`AST`æ ‘![image-20211202150933670.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/af713fef6e584fea9e468c2b5acee9da~tplv-k3u1fbpfcp-zoom-1.image)

1.é¦–å…ˆåœ¨`babel.config.js`åŒçº§æ–°å¢ä¸€ä¸ª`babel-plugin-component.js`æ–‡ä»¶ï¼Œä½œä¸ºæˆ‘ä»¬æ’ä»¶æ–‡ä»¶ï¼Œç„¶åä¿®æ”¹ä¸€ä¸‹`babel.config.js`æ–‡ä»¶ï¼š

```
module.exports =
 {  *// ...* Â 
 plugins: ['./babel-plugin-component.js'] }
```

2.æˆ‘ä»¬å°±æ˜¯è¦ä¿®æ”¹babel.config.jsä½¿å¾—`import { Alert } from 'xui'`å¯¹åº”çš„ASTæ ‘è½¬åŒ–æˆ`import {Alert from 'xui/packages/alert'`å¯¹åº”çš„ASTæ ‘ã€‚

é€šè¿‡è§‚å¯Ÿ`import { Alert } from 'xui'`ä»£ç å¯¹åº”çš„ASTæ ‘ï¼Œæˆ‘ä»¬å‘ç°æ•´ä½“æ˜¯ä¸€ä¸ª`importDeclaration`ï¼Œé€šè¿‡`source.value`åˆ¤æ–­å¯¼å…¥çš„æ¥æºï¼Œ`specifiers`æ•°ç»„å¯ä»¥æ‰¾åˆ°å¯¼å…¥çš„å˜é‡ï¼Œæ¯ä¸ªå˜é‡æ˜¯ä¸€ä¸ª`ImportSpecifier`ã€‚æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹`source.value`å¯¼å…¥çš„æ¥æºï¼Œå¹¶ä¿®æ”¹`specifiers.imported.name`å¯¼å…¥çš„ç»„ä»¶åï¼Œå°±å¯ä»¥å®ç°æç®€åœ°å¼•å…¥ç»„ä»¶ã€‚

3.ç›®æ ‡æ˜ç¡®åï¼Œå¾—åˆ°ä»£ç 

```
// babel-plugin-component.js
module.exports = ({
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   types
 Â  Â  Â  Â  Â  Â  Â  Â   }) => {
 Â   return {
 Â  Â  Â   //Babelé‡‡ç”¨é€’å½’çš„æ–¹å¼è®¿é—®æ‰€æœ‰çš„ASTç»“ç‚¹
 Â  Â  Â   visitor: {
 Â  Â  Â  Â  Â   //æ¯ä¸ªASTç»“ç‚¹éƒ½æœ‰å¯¹åº”çš„èŠ‚ç‚¹ç±»å‹ï¼Œå¦‚Identifierï¼ˆæ ‡è¯†ç¬¦ï¼‰ï¼ŒFunctionDeclarationï¼ˆå‡½æ•°å£°æ˜ï¼‰
 Â  Â  Â  Â  Â   //ä¸€æ—¦è®¿é—®åˆ°ç›¸åŒç±»å‹çš„ç»“ç‚¹è§¦å‘äº‹ä»¶ã€‚é€šè¿‡pathå¯ä»¥ä»£è¡¨è¯¥ç»“ç‚¹çš„å±æ€§ä¸è¯¥ç»“ç‚¹çš„ç›¸é‚»ç»“ç‚¹
 Â  Â  Â  Â  Â   //stateä»£è¡¨æ’ä»¶çš„çŠ¶æ€
 Â  Â  Â  Â  Â   ImportDeclaration(path) {
 Â  Â  Â  Â  Â  Â  Â   const {
 Â  Â  Â  Â  Â  Â  Â  Â  Â   node
 Â  Â  Â  Â  Â  Â  Â   } = path
 Â  Â  Â  Â  Â  Â  Â   // pathæ˜¯ç±»å‹ä¸ºImportDeclarationçš„ASTç»“ç‚¹
 Â  Â  Â  Â  Â  Â  Â   const {
 Â  Â  Â  Â  Â  Â  Â  Â  Â   value
 Â  Â  Â  Â  Â  Â  Â   } = node.source  // node.sourceæ˜¯å¯¼å…¥çš„æ¥æº
â€‹
 Â  Â  Â  Â  Â  Â  Â   if (value === '../UI') {
 Â  Â  Â  Â  Â  Â  Â  Â  Â   // æ‰¾å‡ºå¼•å…¥çš„ç»„ä»¶åç§°åˆ—è¡¨
 Â  Â  Â  Â  Â  Â  Â  Â  Â   let specifiersList = []
 Â  Â  Â  Â  Â  Â  Â  Â  Â   // specifiersæ•°ç»„é‡Œå¯ä»¥æ‰¾åˆ°å¯¼å…¥çš„å˜é‡ï¼Œæ¯ä¸ªå˜é‡æ˜¯ä¸€ä¸ªImportSpecifier
 Â  Â  Â  Â  Â  Â  Â  Â  Â   node.specifiers.forEach(spec => {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   if (types.isImportSpecifier(spec)) {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   if(spec.imported.name.toLowerCase()==='ui'){
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   return types.importDeclaration([
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   types.importDefaultSpecifier(types.identifier(spec.imported.name))
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   ], types.stringLiteral('../UI'))    //stringLiteralå­—ç¬¦ä¸²å­—é¢é‡ï¼Œ@babel/typesè´Ÿè´£babelè½¬æ¢çš„æ­¥éª¤ï¼Œå¯¹ç»“ç‚¹è¿›è¡Œå¢åˆ æ”¹
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   specifiersList.push(spec.imported.name)
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   //spec.imported.nameæ˜¯ç»„ä»¶å¯¼å…¥çš„åç§°ï¼Œspec.local.nameä½œä¸ºç»„ä»¶çš„åˆ«å
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â  Â  Â  Â  Â   })
 Â  Â  Â  Â  Â  Â  Â  Â  Â   // ç»™æ¯ä¸ªç»„ä»¶åˆ›å»ºä¸€æ¡å¯¼å…¥è¯­å¥
 Â  Â  Â  Â  Â  Â  Â  Â  Â   const importDeclarationList = specifiersList.map((name) => {
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   // æ–‡ä»¶å¤¹çš„åç§°é¦–å­—æ¯ä¸ºå°å†™
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   let lowerCaseName = name.toLowerCase();
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   // æ„é€ importDeclarationèŠ‚ç‚¹
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   return types.importDeclaration([
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   types.importDefaultSpecifier(types.identifier(name))
 Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â   ], types.stringLiteral('../UI/packages/' + lowerCaseName))
 Â  Â  Â  Â  Â  Â  Â  Â  Â   })
 Â  Â  Â  Â  Â  Â  Â  Â  Â   // ç”¨å¤šèŠ‚ç‚¹æ›¿æ¢å•èŠ‚ç‚¹
 Â  Â  Â  Â  Â  Â  Â  Â  Â   path.replaceWithMultiple(importDeclarationList)
 Â  Â  Â  Â  Â  Â  Â   }
 Â  Â  Â  Â  Â   }
 Â  Â  Â   },
 Â   }
}
â€‹
```

åœ¨è‡ªå·±çš„é¡¹ç›®ä¸­ï¼Œéœ€è¦æ”¹åŠ¨`if (value === 'xui'`)å’Œ`types.stringLiteral('xui/packages/' + lowerCaseName))`ä¸¤æ®µä»£ç ã€‚æ”¹æˆè‡ªå·±é¡¹ç›®çš„ç»„ä»¶è·¯å¾„å³å¯ã€‚

### babelçš„å¤„ç†æ­¥éª¤

ä¸»è¦æœ‰ä¸‰ä¸ªé˜¶æ®µï¼šè§£æï¼ˆparseï¼‰ï¼Œ è½¬æ¢ ï¼ˆtransformï¼‰ï¼Œç”Ÿæˆï¼ˆgenerateï¼‰ã€‚

-   ##### parse

å°†æºç è½¬æˆ ASTï¼Œç”¨åˆ°@babel/parseræ¨¡å—ã€‚

-   ##### transform

å¯¹AST è¿›è¡Œéå†ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å¯¹èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€æ›´æ–°åŠç§»é™¤ç­‰æ“ä½œã€‚å› æ­¤è¿™æ˜¯bebelå¤„ç†ä»£ç çš„æ ¸å¿ƒæ­¥éª¤ï¼Œæ˜¯æˆ‘ä»¬çš„è®¨è®ºé‡ç‚¹ï¼Œä¸»è¦ä½¿ç”¨@babel/traverseå’Œ@babel/typesæ¨¡å—ã€‚

-   ##### generate

æ‰“å° AST æˆç›®æ ‡ä»£ç å¹¶ç”Ÿæˆ sourcemapï¼Œç”¨åˆ°@babel/generateæ¨¡å—ã€‚

[æµ…è°ˆå‰ç«¯ASTçš„æ¦‚å¿µä¸å®é™…åº”ç”¨ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7006919355686453279#heading-3)


