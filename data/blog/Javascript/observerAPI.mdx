---
title: 'ğŸ›¸ Observer APIæœºåˆ¶'
date: '2023-2-8'
tags: ['Javascript']
draft: false
summary: 'Intersection Observerçš„æ„ä¹‰ï¼šæƒ³è¦è®¡ç®—Webé¡µé¢çš„å…ƒç´ çš„ä½ç½®åç§»å°ºå¯¸ï¼Œè§†å£å°ºå¯¸ï¼Œæ»šåŠ¨å°ºå¯¸ï¼Œä¼šä¾èµ–äºDOMçš„æ˜¾ç¤ºæŸ¥è¯¢ï¼Œæ¯ä¸€æ¬¡è®¿é—®ä¼šå¼•èµ·å›æµï¼Œä¸”ä¸åœè½®è¯¢å¸¦æ¥å¤§é‡çš„æ€§èƒ½æµªè´¹ã€‚'
---

# Javascriptä¹‹observerAPI

- `Intersection Observer`ï¼Œäº¤å‰è§‚å¯Ÿè€…ã€‚
- `Mutation Observer`ï¼Œå˜åŠ¨è§‚å¯Ÿè€…ï¼ˆçº¢å®ä¹¦æœ‰è¯¦å®çš„ä¾‹å­æš‚ä¸”ä¸è¡¨ï¼‰ã€‚
- `Resize Observer`ï¼Œè§†å›¾è§‚å¯Ÿè€…ã€‚
- `Performance Observer`ï¼Œæ€§èƒ½è§‚å¯Ÿè€…


[ç°ä»£æµè§ˆå™¨è§‚å¯Ÿè€… Observer API æŒ‡å— - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/6844903976937209863)

# Intersection Observer

## 1.å‡ºç°çš„æ„ä¹‰

æƒ³è¦è®¡ç®—Webé¡µé¢çš„å…ƒç´ çš„ä½ç½®åç§»å°ºå¯¸ï¼Œè§†å£å°ºå¯¸ï¼Œæ»šåŠ¨å°ºå¯¸ï¼Œä¼šä¾èµ–äºDOMçš„æ˜¾ç¤ºæŸ¥è¯¢ï¼Œæ¯ä¸€æ¬¡è®¿é—®ä¼šå¼•èµ·å›æµï¼Œä¸”ä¸åœè½®è¯¢å¸¦æ¥å¤§é‡çš„æ€§èƒ½æµªè´¹ã€‚

å¯¹äºè¿™äº›é—®é¢˜ï¼Œå‘å±•äº†ä»¥ä¸‹çš„å‡ ç§æ–¹æ¡ˆï¼š

- æ„å»ºDOMå’Œæ•°æ®çš„è‡ªå®šä¹‰é¢„åŠ è½½å’Œå»¶è¿ŸåŠ è½½ã€‚
- å®ç°äº†æ•°æ®ç»‘å®šçš„é«˜æ€§èƒ½æ»šåŠ¨åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨åŠ è½½å’Œå‘ˆç°æ•°æ®é›†çš„å­é›†ã€‚
- é€šè¿‡`scroll`ç­‰äº‹ä»¶æˆ–é€šè¿‡æ’ä»¶çš„å½¢å¼ï¼Œè®¡ç®—çœŸå®å…ƒç´ å¯è§æ€§ã€‚

è€Œå®ƒä»¬éƒ½æœ‰å‡ é¡¹å…±åŒç‰¹ç‚¹ï¼š

1. åŸºæœ¬å®ç°å½¢å¼éƒ½æ˜¯æŸ¥è¯¢å„ä¸ªå…ƒç´ ç›¸å¯¹ä¸æŸäº›å…ƒç´ ï¼ˆå…¨å±€è§†å£ï¼‰çš„â€œè¢«åŠ¨æŸ¥è¯¢â€ã€‚
2. ä¿¡æ¯å¯ä»¥å¼‚æ­¥ä¼ é€’ï¼ˆä¾‹å¦‚ä»å¦ä¸€ä¸ªçº¿ç¨‹ä¼ é€’ï¼‰ï¼Œä¸”æ²¡æœ‰ç»Ÿä¸€æ•è·é”™è¯¯çš„å¤„ç†ã€‚
3. `web`å¹³å°æ”¯æŒåŒ®ä¹ï¼Œå„æœ‰å„å®¶çš„å¤„ç†ã€‚éœ€è¦å¼€å‘äººå‘˜æ¶ˆè€—å¤§é‡ç²¾åŠ›å…¼å®¹ã€‚

## 2. `IntersectionObserver`çš„ä¼˜åŠ¿

`Intersection Observer API`é€šè¿‡ä¸ºå¼€å‘äººå‘˜æä¾›ä¸€ç§æ–°æ–¹æ³•æ¥å¼‚æ­¥æŸ¥è¯¢å…ƒç´ ç›¸å¯¹äºå…¶ä»–å…ƒç´ æˆ–å…¨å±€è§†å£çš„ä½ç½®ï¼Œä»è€Œè§£å†³äº†ä¸Šè¿°é—®é¢˜:

- **å¼‚æ­¥å¤„ç†**æ¶ˆé™¤äº†æ˜‚è´µçš„`DOM`å’Œæ ·å¼æŸ¥è¯¢ï¼Œè¿ç»­è½®è¯¢ä»¥åŠä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶çš„éœ€æ±‚ã€‚
- é€šè¿‡æ¶ˆé™¤å¯¹è¿™äº›æ–¹æ³•çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿åº”ç”¨ç¨‹åºæ˜¾ç€é™ä½`CPU`ï¼Œ`GPU`å’Œèµ„æºæˆæœ¬ã€‚

## 3. `IntersectionObserver`åŸºæœ¬ä½¿ç”¨

ä½¿ç”¨`IntersectionObserver API`ä¸»è¦éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»ºè§‚å¯Ÿè€…
2. å®šä¹‰å›è°ƒäº‹ä»¶
3. å®šä¹‰è¦è§‚å¯Ÿçš„ç›®æ ‡å¯¹è±¡

### 1ï¼‰åˆ›å»ºè§‚å¯Ÿè€…

```
const options = {
          root:document.querySelector('.scrollContainer'),
    rootMargin:'0px',
    threshold:[0.3,0.5,0.8,1],
}
//1.root:æŒ‡å®šä¸€ä¸ªæ ¹å…ƒç´ 
//2.rootMargin:æŒ‡å®šæ ¹è¾¹è·ï¼Œä¼šå½±å“æ ¹å…ƒç´ çš„è§‚å¯Ÿå½±å“èŒƒå›´
//3.threshold:é˜ˆå€¼ï¼Œå¯ä»¥ä¸ºæ•°ç»„ï¼Œ[0.3,0.5,0.8,1]æ„å‘³ç€å½“ç›®æ ‡å…ƒç´ å æ ¹å…ƒç´ å¯è§åŒºåŸŸçš„30%,50%,80%,100%ä¼šè§¦å‘å¤„ç†å‡½æ•°
```


### 2ï¼‰å®šä¹‰å›è°ƒå‡½æ•°

å½“ç›®æ ‡å…ƒç´ ä¸æ ¹å…ƒç´ åˆ°è¾¾é˜ˆå€¼ç›¸äº¤æ—¶ï¼Œå°±ä¼šè§¦å‘å›è°ƒå‡½æ•°ã€‚

```
function handler (entries, observer) {
    entries.forEach(entry => {
    // æ¯ä¸ªæˆå‘˜éƒ½æ˜¯ä¸€ä¸ªIntersectionObserverEntryå¯¹è±¡ã€‚
    // ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœåŒæ—¶æœ‰ä¸¤ä¸ªè¢«è§‚å¯Ÿçš„å¯¹è±¡çš„å¯è§æ€§å‘ç”Ÿå˜åŒ–ï¼Œentriesæ•°ç»„å°±ä¼šæœ‰ä¸¤ä¸ªæˆå‘˜ã€‚
    // entry.boundingClientRect ç›®æ ‡å…ƒç´ çš„ä½ç½®ä¿¡æ¯
    // entry.intersectionRatio ç›®æ ‡å…ƒç´ çš„å¯è§æ¯”ä¾‹
    // entry.intersectionRect äº¤å‰éƒ¨åˆ†çš„ä½ç½®ä¿¡æ¯
    // entry.isIntersecting ç›®æ ‡å…ƒç´ æ˜¯å¦å¯è§
    // entry.rootBounds æ ¹å…ƒç´ çš„ä½ç½®
    // entry.target
    // entry.time æ—¶é—´æˆ³
    });
}

```

### 3ï¼‰å®šä¹‰è¦è§‚å¯Ÿçš„ç›®æ ‡å¯¹è±¡

ä»»ä½•ç›®æ ‡å…ƒç´ éƒ½å¯ä»¥é€šè¿‡è°ƒç”¨.observe(target)æ–¹æ³•æ¥è§‚å¯Ÿã€‚

```
const target = document.querySelector('.targetBox');
observer.observe(target);
//åœæ­¢å¯¹æŸä¸ªç›®æ ‡çš„ç›‘å¬
observer.unobserve(target);
//ç»ˆæ­¢å¯¹æ‰€æœ‰ç›®æ ‡çš„ç›‘å¬
observer.disconnect();
```

## 4.`IntersectionObserver`çš„ä½¿ç”¨åœºæ™¯

### ä¾‹å­1ï¼šå›¾ç‰‡æ‡’åŠ è½½

`HTML`:

```
<img src="placeholder.png" data-src="img-1.jpg">
<img src="placeholder.png" data-src="img-2.jpg">
<img src="placeholder.png" data-src="img-3.jpg">
<!-- more images -->
å¤åˆ¶ä»£ç 
```

è„šæœ¬ï¼š

```
let observer = new IntersectionObserver(
(entries, observer) => {
entries.forEach(entry => {
    /* æ›¿æ¢å±æ€§ */
    entry.target.src = entry.target.dataset.src;
    observer.unobserve(entry.target);
  });
},
{rootMargin: "0px 0px -200px 0px"});

document.querySelectorAll('img').forEach(img => { observer.observe(img) });

```

ä¸Šè¿°ä¾‹å­è¡¨ç¤º ä»…åœ¨åˆ°è¾¾è§†å£è·ç¦»åº•éƒ¨200pxè§†åŠ è½½å›¾ç‰‡ã€‚

PSï¼šmarginçš„è´Ÿå€¼æ˜¯ä»€ä¹ˆå«ä¹‰

[æµ…è°ˆmarginè´Ÿå€¼ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/25892372)

![https://pic3.zhimg.com/v2-a7d813afe7ab2c6c4233146609d00dfa_r.jpg](https://pic3.zhimg.com/v2-a7d813afe7ab2c6c4233146609d00dfa_r.jpg)

preview

çº¢è‰²ç®­å¤´çš„æ–¹å‘æ˜¯marginä¸ºæ­£å€¼æ—¶çš„ç§»åŠ¨æ–¹å‘ï¼›é‚£ä¹ˆmarginä¸ºè´Ÿå€¼æ—¶ï¼Œç§»åŠ¨æ–¹å‘ç›¸åã€‚

PSï¼šå…ƒç´ èƒŒæ™¯çš„èŒƒå›´

`background-color` å±æ€§ä¸ºå…ƒç´ è®¾ç½®ä¸€ç§çº¯è‰²ã€‚è¿™ç§é¢œè‰²ä¼š**å¡«å……å…ƒç´ çš„å†…å®¹ã€å†…è¾¹è·å’Œè¾¹æ¡†åŒºåŸŸï¼Œæ‰©å±•åˆ°å…ƒç´ è¾¹æ¡†çš„å¤–è¾¹ç•Œ**ï¼ˆä½†ä¸åŒ…æ‹¬å¤–è¾¹è·ï¼‰ã€‚å¦‚æœè¾¹æ¡†æœ‰é€æ˜éƒ¨åˆ†ï¼ˆå¦‚è™šçº¿è¾¹æ¡†ï¼‰ï¼Œä¼šé€è¿‡è¿™äº›é€æ˜éƒ¨åˆ†æ˜¾ç¤ºå‡ºèƒŒæ™¯è‰²ã€‚

### ä¾‹å­2ï¼šå…´è¶£åŸ‹ç‚¹

```
const boxList = [...document.querySelectorAll('.box')]

var io = new IntersectionObserver((entries) =>{
  entries.forEach(item => {
    // intersectionRatio === 1è¯´æ˜è¯¥å…ƒç´ å®Œå…¨æš´éœ²å‡ºæ¥ï¼Œç¬¦åˆä¸šåŠ¡éœ€æ±‚
    if (item.intersectionRatio === 1) {
      // ã€‚ã€‚ã€‚ åŸ‹ç‚¹æ›å…‰ä»£ç 
      io.unobserve(item.target)
    }
  })
}, {
  root: null,
  threshold: 1, // é˜€å€¼è®¾ä¸º1ï¼Œå½“åªæœ‰æ¯”ä¾‹è¾¾åˆ°1æ—¶æ‰è§¦å‘å›è°ƒå‡½æ•°
})

// observeéå†ç›‘å¬æ‰€æœ‰boxèŠ‚ç‚¹
boxList.forEach(box => io.observe(box))

```

è‡³äºæ€æ ·è¯„æ–­ç”¨æˆ·æ˜¯å¦æ„Ÿå…´è¶£ï¼Œè®°å½•æ–¹å¼å°±è§ä»è§æ™ºäº†ï¼š

- ä½äºå±å¹•ä¸­é—´ï¼Œå¹¶åœç•™æ—¶é•¿å¤§äº2ç§’ï¼Œè®¡æ•°ä¸€æ¬¡ã€‚
- åŒºåŸŸæ‚¬åœï¼Œè§¦å‘å®šæ—¶å™¨è®°å½•æ—¶é—´ã€‚
- `PC`ç«¯è®°å½•é¼ æ ‡ç‚¹å‡»æ¬¡æ•°/æ‚¬åœæ—¶é—´ï¼Œç§»åŠ¨ç«¯è®°å½•`touch`äº‹ä»¶

**ä¾‹å­3ï¼šæ§åˆ¶åŠ¨ç”»/è§†é¢‘**

`HTML`:

```
<video src="OSRO-animation.mp4" controls=""></video>

```

`js`:

```
let video = document.querySelector('video');
let isPaused = false; /* Flag for auto-paused video */
let observer = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if(entry.intersectionRatio!=1  && !video.paused){
      video.pause(); isPaused = true;
    }
    else if(isPaused) {video.play(); isPaused=false}
  });
}, {threshold: 1});
observer.observe(video);
```

åŸç†ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå½“æˆ‘ä»¬ç›®æ ‡å…ƒç´ å æ ¹å…ƒç´ å¯è§†åŒºåŸŸ100%æ—¶ï¼Œè§†é¢‘æ’­æ”¾playï¼›å¦åˆ™ï¼Œè§†é¢‘æš‚åœpauseã€‚

# Resize Observer

## 1. å‡ºç°çš„æ„ä¹‰

- å¼€å‘è¿‡ç¨‹å½“ä¸­ç»å¸¸é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚ä½•ç›‘å¬ä¸€ä¸ª `div` çš„å°ºå¯¸å˜åŒ–ã€‚
- ä½†ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸ºäº†ç›‘å¬ `div` çš„å°ºå¯¸å˜åŒ–ï¼Œéƒ½å°†ä¾¦å¬å™¨é™„åŠ åˆ° `window` ä¸­çš„ `resize` äº‹ä»¶ã€‚
- ä½†è¿™å¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå¤§é‡çš„è§¦å‘äº‹ä»¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¸ƒå±€å‡ºé”™ã€‚

`window.resize` é€šå¸¸æ˜¯æµªè´¹çš„ï¼Œå› ä¸ºå®ƒå‘Šè¯‰æˆ‘ä»¬æ¯ä¸ªè§†çª—å¤§å°çš„å˜åŒ–ï¼Œè€Œä¸ä»…ä»…æ˜¯å½“ä¸€ä¸ªå…ƒç´ çš„å¤§å°å‘ç”Ÿå˜åŒ–ã€‚

> resizeäº‹ä»¶ä¼šåœ¨ä¸€ç§’å†…è§¦å‘å°†è¿‘60æ¬¡ï¼Œå¾ˆå®¹æ˜“åœ¨æ”¹å˜çª—å£å¤§å°æ—¶å¯¼è‡´æ€§èƒ½é—®é¢˜
> 

æ¯”å¦‚è¯´ï¼Œä½ è¦è°ƒæ•´ä¸€ä¸ªå…ƒç´ çš„å¤§å°ï¼Œé‚£å°±éœ€è¦åœ¨ `resize` çš„å›è°ƒå‡½æ•° `callback()` ä¸­è°ƒç”¨ `getBoundingClientRect` æˆ– `getComputerStyle`ã€‚ä¸è¿‡ä½ è¦æ˜¯ä¸å°å¿ƒå¤„ç†æ‰€æœ‰çš„è¯»å’Œå†™æ“ä½œï¼Œå°±ä¼šå¯¼è‡´å¸ƒå±€æ··ä¹±ã€‚æ¯”å¦‚ä¸‹é¢è¿™ä¸ªå°ç¤ºä¾‹ï¼š

## 2. `ResizeObserver`çš„ä¼˜åŠ¿

`ResizeObserver API` çš„æ ¸å¿ƒä¼˜åŠ¿æœ‰ä¸¤ç‚¹ï¼š

- ç»†é¢—ç²’åº¦çš„`DOM`å…ƒç´ è§‚å¯Ÿï¼Œè€Œä¸æ˜¯`window`
- æ²¡æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œåªä¼šåœ¨ç»˜åˆ¶å‰æˆ–å¸ƒå±€åè§¦å‘è°ƒç”¨

## 3. `ResizeObserver`åŸºæœ¬ä½¿ç”¨

ä½¿ç”¨`ResizeObserver API`åŒæ ·ä¹Ÿæ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼š

1. åˆ›å»ºè§‚å¯Ÿè€…
    
    let observer = new ResizeObserver(callback);
    
2. å®šä¹‰å›è°ƒå‡½æ•°
    
    ```
    const callback = entries => {
        entries.forEach(entry => {
    
        })
    }
    ```
    
    æ¯ä¸€ä¸ª`entry`éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä¸¤ä¸ªå±æ€§`contentRect`å’Œ`target`
    
    `contentRect`(åªè¯»çš„)éƒ½æ˜¯ä¸€äº›ä½ç½®ä¿¡æ¯ï¼š
        
3. å®šä¹‰è¦è§‚å¯Ÿçš„ç›®æ ‡å¯¹è±¡

```
observer.observe(document.body);
//å–æ¶ˆå•ä¸ªè§‚å¯Ÿ
observer.unobserve(document.body);
//å–æ¶ˆæ‰€æœ‰ç»“ç‚¹è§‚å¯Ÿ
observer.disconnect();
```