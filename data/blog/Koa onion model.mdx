---
title: 'ğŸ¤” æ·±å…¥æµ…å‡ºKoaæ´‹è‘±æ¨¡å‹'
date: '2022-08-14'
tags: ['Koa']
draft: false
summary: 'æ¯ä¸€å±‚ç›¸å½“äºä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨æ¥è¿›è¡Œç‰¹å®šçš„å¤„ç†ï¼Œå¦‚é”™è¯¯å¤„ç†ï¼ŒSessionå¤„ç†ç­‰ã€‚å¤„ç†é¡ºåºæ˜¯next()å‰çš„è¯·æ±‚ï¼ˆRequestï¼Œä»å¤–å±‚åˆ°å†…å±‚ï¼‰ï¼Œç„¶åæ‰§è¡Œnextå‡½æ•°ï¼Œæœ€åæ˜¯nextåçš„å“åº”ï¼ˆResponseï¼Œä»å†…å±‚åˆ°å¤–å±‚)'
---



## ä»€ä¹ˆæ˜¯Koaæ´‹è‘±æ¨¡å‹ï¼Ÿ

æ¯ä¸€å±‚ç›¸å½“äºä¸€ä¸ªä¸­é—´ä»¶ï¼Œç”¨æ¥è¿›è¡Œç‰¹å®šçš„å¤„ç†ï¼Œå¦‚é”™è¯¯å¤„ç†ï¼ŒSessionå¤„ç†ç­‰ã€‚å¤„ç†é¡ºåºæ˜¯next()å‰çš„è¯·æ±‚ï¼ˆRequestï¼Œä»å¤–å±‚åˆ°å†…å±‚ï¼‰ï¼Œç„¶åæ‰§è¡Œnextå‡½æ•°ï¼Œæœ€åæ˜¯nextåçš„å“åº”ï¼ˆResponseï¼Œä»å†…å±‚åˆ°å¤–å±‚ï¼‰

æ¯ä¸€ä¸ªä¸­é—´ä»¶æœ‰ä¸¤æ¬¡å¤„ç†çš„æ—¶æœº

## ä¸ºä»€ä¹ˆä½¿ç”¨Koaæ´‹è‘±æ¨¡å‹ï¼Ÿ

å¦‚æœä¸€ä¸ªä¸­é—´ä»¶ä¾èµ–äºå¦ä¸€ä¸ªä¸­é—´ä»¶çš„é€»è¾‘

æ¯”å¦‚è¯´ä¸€ä¸ªè¯·æ±‚æˆ–æ“ä½œdbæ‰€èŠ±è´¹çš„æ—¶é—´

```jsx
app.use(async (ctx, next) => {
	const start = Date.now();
	await next();
	const end = Date.now();
	console.log(`è¯·æ±‚è€—æ—¶${end-start}ms`);
})
app.use(async (ctx, next) => {
	ctx.body = await axios.get('baidu.com') 
})
```

## æ´‹è‘±æ¨¡å‹çš„å®ç°åŸç†

```jsx
const Koa = require('koa');

//Applications
const app = new Koa();

// ä¸­é—´ä»¶1
app.use((ctx, next) => {
console.log(1);
next();
console.log(2);
});

// ä¸­é—´ä»¶ 2
app.use((ctx, next) => {
console.log(3);
next();
console.log(4);
});

app.listen(9000, '0.0.0.0', () => {
console.log(`Server is starting`);
});
```

ä»¥ä¸Šé¢çš„ä»£ç ä¸ºä¾‹å­ï¼Œæ·±å…¥è§£æuseï¼Œlistenæ–¹æ³•

```jsx
// useæ–¹æ³•
// useæ–¹æ³•ç›¸å½“ç®€å•ï¼Œå°±æ˜¯æŠŠfnæ”¾å…¥this.middlewareä¸­é—´ä»¶å‡½æ•°åˆ—è¡¨
// return this,æ˜¯ä¸ºäº†é“¾å¼è°ƒç”¨
use(fn){
	this.middleware.push(fn);
	return this;
}
// listenæ–¹æ³•
// listenæ–¹æ³•æ˜¯å¯¹httpæ¨¡å—createServerçš„å°è£…ï¼Œå¹¶ä¸”ä½¿ç”¨äº†koa-composeæ¨¡å—çš„é‡è¦æ–¹æ³•compose
listen(...argv) {
	const server = http.createServer(this.callback());
	return server.listen(...argv);
}

callback() {
	// compose æ˜¯æœ€é‡è¦ä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°
	const fn = compose(this.middleware);
	// åˆ›å»ºä¸€ä¸ªctxä¸Šä¸‹æ–‡ç¯å¢ƒ
	const handleRequest = (req, res) => {
		const ctx = this.createContext(req, res);
		return this.handleRequest(ctx, fn);
	}
	return handleRequest;
}

handleRequest(ctx, middleware) {
	const res = ctx.res;
	res.status = 404;
	const onerror = (err) => ctx.onerror(err);
	const handleResponse = () => respond(ctx);
	onFinished(res, onerror);
	return middleware(ctx).then(handleResponse).catch(onerrir)
}
```

```jsx
function compose (middleware) {
  // ...
  return function (context, next) {
    // last called middleware #
    let index = -1
    // ä¸€å¼€å§‹çš„æ—¶å€™ä¼ å…¥ä¸º 0ï¼Œåç»­ä¼šé€’å¢
    return dispatch(0)
    function dispatch (i) {
      // å‡å¦‚æ²¡æœ‰é€’å¢ï¼Œåˆ™è¯´æ˜æ‰§è¡Œäº†å¤šæ¬¡
      if (i <= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      // æ‹¿åˆ°å½“å‰çš„ä¸­é—´ä»¶
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      // å½“ fn ä¸ºç©ºçš„æ—¶å€™ï¼Œå°±ä¼šå¼€å§‹æ‰§è¡Œ next() åé¢éƒ¨åˆ†çš„ä»£ç 
      if (!fn) return Promise.resolve()
      try {
        // æ‰§è¡Œä¸­é—´ä»¶ï¼Œç•™æ„è¿™ä¸¤ä¸ªå‚æ•°ï¼Œéƒ½æ˜¯ä¸­é—´ä»¶çš„ä¼ å‚ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä¸Šä¸‹æ–‡ï¼Œç¬¬äºŒä¸ªæ˜¯ next å‡½æ•°
        // ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œ next çš„æ—¶å€™ä¹Ÿå°±æ˜¯è°ƒç”¨ dispatch å‡½æ•°çš„æ—¶å€™
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
```

## æ´‹è‘±æ¨¡å‹çš„ç®€æ˜“Demo

```jsx
const middleware = []
let mw1 = async function (ctx, next) {
    console.log("nextå‰ï¼Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶")
    await next()
    console.log("nextåï¼Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶")
}
let mw2 = async function (ctx, next) {
    console.log("nextå‰ï¼Œç¬¬äºŒä¸ªä¸­é—´ä»¶")
    await next()
    console.log("nextåï¼Œç¬¬äºŒä¸ªä¸­é—´ä»¶")
}
let mw3 = async function (ctx, next) {
    console.log("ç¬¬ä¸‰ä¸ªä¸­é—´ä»¶ï¼Œæ²¡æœ‰nextäº†")
}

function use(mw) {
  middleware.push(mw);
}

function compose(middleware) {
  return (ctx, next) => {
    return dispatch(0);
    function dispatch(i) {
      const fn = middleware[i];
      if (!fn) return;
      return fn(ctx, dispatch.bind(null, i+1));
    }
  }
}

use(mw1);
use(mw2);
use(mw3);

const fn = compose(middleware);

fn();
```